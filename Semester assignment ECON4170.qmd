---
title: "Semester project for ECON4170"
format: html
editor: visual
execute: 
  echo: false
  warning: false
  message: false
---

## introduction

this is a semester project where we will be making a model to see if we can predict the price of electricity in Norway, one day (24 hours) ahead of time. we want to create a model that beats the naive benchmark.

## Data

the data that we will be using comes from ENTSO-E. we have gotten a yearly report for this year (up to the 27th of October) with the time between measurements being every 15 minutes, across an entire 24-hour period. its an excel file (CSV). the original currency that is displayed in the excel file is in EUR.

we will transform this data to fit our needs as we go. to start, we will be adding a new collumn that converts the currency and price, to something that displays NOK. To do this, we will use todays current exchange rate. (11,68 NOK per EUR, as of the 26th of October 2025)

## Running Code

```{r}

##first dataset: electricity price history

library(tidyverse) #standard package for most projects in this course
library(janitor) #used by professor in seminar 5 solution
library(lubridate) #found in syllabus


ELP <- readr::read_csv("GUI_ENERGY_PRICES_202412312300-202512312300.csv") %>%
  clean_names() %>%
  mutate(
    Price_time = dmy_hms(sub("- .*","",mtu_cet_cest)),
    hourly_time = floor_date(Price_time, "hour"), #setting the intervals to every hour
    Price_EUR = day_ahead_price_eur_m_wh,
    Price_NOK = Price_EUR * 11.68) %>%
  group_by(hourly_time) %>%
  summarise(
    Price_EUR = mean(Price_EUR, na.rm = TRUE),
    Price_NOK = mean(Price_NOK, na.rm = TRUE), 
    .groups = "drop")

## other vaiables: water reservior levels and temprature history

Total_load <- readr::read_csv("GUI_TOTAL_LOAD_DAYAHEAD_202412312300-202512312300.csv") %>%
  clean_names() %>%
  mutate(
    hourly_time = dmy_hm(sub("- .*","",mtu_cet_cest)),
    load = actual_total_load_mw) %>%
  select(hourly_time, load)

# water reservior levels

reservior_Weekly <- readr::read_csv("GUI_WATER_RESERVOIRS_HYDRO_STORAGE_202412312300-202512312300.csv") %>% 
  clean_names() %>%
  separate(time_interval, c("start", "end"), sep = " - .*") %>%
  transmute(
    hourly_time = as.POSIXct(dmy(start)),
    Energy = parse_number(energy_m_wh)) %>%
  arrange(hourly_time)

reservior_hourly <- ELP %>%
  select(hourly_time) %>%
  left_join(reservior_Weekly, by = "hourly_time") %>%
  arrange(hourly_time) %>%
  fill(Energy, .direction = "down") %>%
  fill(Energy, .direction = "up")


ggplot(ELP, aes(x =hourly_time, y = Price_NOK)) + #ggplot to check up on the data
  geom_line() +
  labs(title = "Electricity prices (hourly)")

```

```{r}
#Data Wrangling lufttemperatur#
library(tidyverse)
# reading the data set for temperature in NO1#
temp_NO1 <- read.csv("Lufttemperatur_NO1.csv", sep = ";")

#Removing the station column as its not needed##
temp_NO1$Stasjon<- NULL

#renaming column and time format for merging later##
temp_NO1<- temp_NO1%>%
  rename(time = Tid.norsk.normaltid.)%>%
  mutate(time = as.POSIXct(time, format = "%d.%m.%Y %H:%M"))

#substituting "," for "." in the temprature column to make numereic##
temp_NO1<-temp_NO1%>%
  mutate(Lufttemperatur = gsub(",", ".",Lufttemperatur))

#aking the column numeric#
temp_NO1$Lufttemperatur<- as.numeric(temp_NO1$Lufttemperatur)

#creating avgtem by grouping with time and taking the mean at each timestamp#
AvgTempNO1<-temp_NO1 %>%
group_by(time) %>%
  summarize(AvgTempNO1 = mean(Lufttemperatur, na.rm = TRUE))%>%
  drop_na()

```

```{r}
library(lubridate)
library(tidyverse)
#arranging and fixing to merge the files##
price <- ELP 
supply_water <- reservior_hourly
demand <- Total_load
temperature<- AvgTempNO1

#renaming and removing coloumns in supply, price and demand##
supply_water<-supply_water%>%
  rename(time = hourly_time)

price<-price%>%
  rename(time = hourly_time)%>%
  select(time, Price_NOK)

demand<- demand %>%
  rename(time = hourly_time, demand = load)%>%
  mutate(demand = as.numeric(demand))

#need to remove first row from supply, water and demand to fit the time window of temperature#
supply_water<-supply_water[-1,]
demand<- demand [-1,]
price<-price[-1,]

#merging the data#
model_data <- temperature %>%
  inner_join(price,by = "time")%>%
  inner_join(supply_water, by = "time")%>%
  inner_join(demand, by = "time")

#convert timezpne to oslo##

model_data<- model_data%>%
  mutate(time = with_tz(time, "CET"))

#set end timestamp of data to 25.10.25 23:00 because of timechange on the 26th makes data not aligned so it saves trouble ending a few days earlier#

library(dplyr)

model_data <- model_data %>% 
  filter(time <= "2025-10-25 23:00:00")

model_data_winsorized <- model_data %>%
  mutate(
    across(where(is.numeric), ~ {
    low <- quantile(.x, 0.01, na.rm = TRUE)
    high <- quantile(.x, 0.99, na.rm = TRUE)
    pmin(pmax(.x, low), high)}))


ggplot(model_data_winsorized, aes(x = time, y = Price_NOK)) +
  geom_line(size = 0.45)
ggplot(model_data_winsorized, aes(x = time, y = AvgTempNO1)) +
  geom_line(size = 0.45)
ggplot(model_data_winsorized, aes(x = time, y = Energy)) +
  geom_line()
ggplot(model_data_winsorized, aes(x = time, y = demand)) +
  geom_line(size = 0.1) #graphs tell us that there is a trend with increasing temp an decreacing demand for energy.


cor(model_data_winsorized$Price_NOK, model_data_winsorized$AvgTempNO1, use = "complete.obs") #(-0.28) higher temp means lower price.
cor(model_data_winsorized$demand, model_data_winsorized$AvgTempNO1, use = "complete.obs") # (-0.856) lower temps means higher price


#because the higher the tempreature is, the lower demand is, we can find a point in temp that makes for a better variable to work with. saying that a temp of 18 degrees and above makes for a demand of 0 on heating. making temp a more linear variable the lower temp drops. easier to model with.
#also creating lags for the variables we have

clean_data <- model_data_winsorized %>%
  arrange(time) %>%
  mutate(HDH = pmax(0, 18 - AvgTempNO1)) %>%
  mutate(
    price_lag1 = lag(Price_NOK, 1),
    price_lag24 = lag(Price_NOK, 24),
    price_lag168 = lag(Price_NOK, 168),
    
    HDH_lag0 = HDH,
    HDH_lag24 = lag(HDH, 24),
    
    demand_lag0 = demand,
    demand_lag24 = lag(demand, 24),
    
    supply_lag0 = Energy,
    supply_lag168 = lag(Energy, 168))

cor(clean_data$Price_NOK, clean_data$HDH, use = "complete.obs") #higher HDH means a higher price
cor(clean_data$demand, clean_data$HDH, use = "complete.obs") #higher HDH increases demand for energy




```

